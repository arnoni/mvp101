<!DOCTYPE html>
<html lang="{{ current_lang }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t.title }}</title>
    <!-- Tailwind CSS (mock) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Drilling/Rumble Animation for Item 3 */
        @keyframes drill-rumble {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }

            2% {
                transform: translate(-1px, 1px) rotate(-1deg);
            }

            4% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            6% {
                transform: translate(-1px, -1px) rotate(-1deg);
            }

            8% {
                transform: translate(1px, 1px) rotate(1deg);
            }

            10% {
                transform: translate(0, 0) rotate(0deg);
            }

            /* Pause */
            100% {
                transform: translate(0, 0) rotate(0deg);
            }
        }

        .drill-text {
            /* Drill sound visual: bursts of vibration */
            animation: drill-rumble 2s infinite linear;
            display: inline-block;
        }

        .drill-text:hover {
            /* Continuous drilling on hover */
            animation: drill-rumble 0.2s infinite linear;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8 font-sans text-slate-900">
    <div class="max-w-md w-full space-y-6 bg-white p-8 rounded-2xl shadow-xl border border-slate-100 relative">
        <div class="absolute top-4 left-4 flex flex-col items-start text-xs space-y-1">
            <button id="user-status-text" class="text-slate-700 font-medium hover:underline text-left" onclick="togglePaymentModal()">{{ initial_user_status.text }}</button>
        </div>

        <!-- Language Selector -->
        <div class="absolute top-4 right-4 flex space-x-2 text-xs">
            <a href="?lang=en" onclick="setLang('en')" class="hover:underline {% if current_lang == 'en' %}font-bold{% endif %}">EN</a>
            <span class="text-slate-300">|</span>
            <a href="?lang=es" onclick="setLang('es')" class="hover:underline {% if current_lang == 'es' %}font-bold{% endif %}">ES</a>
            <span class="text-slate-300">|</span>
            <a href="?lang=ru" onclick="setLang('ru')" class="hover:underline {% if current_lang == 'ru' %}font-bold{% endif %}">RU</a>
            <span class="text-slate-300">|</span>
            <a href="?lang=ko" onclick="setLang('ko')" class="hover:underline {% if current_lang == 'ko' %}font-bold{% endif %}">KO</a>
        </div>

        <header class="text-center mb-6 mt-6">
            <!-- Item 2 & 3: Animated Branding with Drilling Effect -->
            <div class="mb-4 flex flex-col items-center justify-center">
                <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight drill-text relative">
                    DillDrill
                    <!-- Item 2: TM Mark (Explicitly positioned and styled) -->
                    <span class="absolute -top-2 -right-6 text-sm font-bold text-slate-400 select-none">&trade;</span>
                </h1>
            </div>
            <p class="text-slate-500 mt-1">{{ t.subtitle }}</p>
            <p class="text-xs text-slate-400 mt-1">{{ t.early_preview }}</p>
        </header>

        <form id="search-form" class="space-y-4">
            <div class="flex justify-between items-center">
                <label for="coordinates" class="block text-sm font-medium text-slate-700">{{ t.input_label }}</label>
                <!-- Item 3: Tutorial Link -->
                <button type="button"
                        onclick="toggleAboutModal()"
                        class="text-xs text-blue-500 hover:text-blue-700 rounded p-1"
                        aria-label="{{ t.how_to_use }}"
                        title="{{ t.how_to_use }}">
                    <span aria-hidden="true" class="font-bold">?</span>
                    <span class="sr-only">{{ t.how_to_use }}</span>
                </button>
            </div>
            <input type="text" id="coordinates" name="coordinates" required placeholder="{{ t.placeholder }}"
                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg shadow-sm transition-all duration-200">

            {% if settings.ENV == 'development' %}
            <div
                class="p-3 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg mb-4 text-sm flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Dev Mode: Extended error info enabled. Turnstile Verification Required.
                {% if using_fallback_quota %}
                <br/>Using inâ€‘memory quota fallback (Redis unavailable or disabled).
                {% endif %}
            </div>
            {% endif %}

            <div id="turnstile-widget" class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" data-callback="turnstileCallback" style="{% if not initial_turnstile_required %}display:none{% endif %}"></div>
            <input type="hidden" id="turnstile-token" name="turnstile_token">

            <button type="submit" id="search-button"
                class="w-full bg-blue-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 shadow-md transition-all duration-200">
                {{ t.button_search }}
            </button>
        </form>

        <div id="results-section" class="mt-8 space-y-4">
            <h2 class="text-xl font-semibold text-slate-800">{{ t.results_header }}</h2>
            <div id="results-empty" class="bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200 rounded-lg p-6 text-center">
                <div class="mx-auto w-24 h-24 mb-3">
                    <svg viewBox="0 0 64 64" class="w-full h-full text-slate-400">
                        <rect x="10" y="22" width="44" height="28" rx="4" fill="currentColor" opacity="0.2"/>
                        <rect x="18" y="26" width="12" height="16" rx="2" fill="currentColor" opacity="0.35"/>
                        <rect x="34" y="26" width="12" height="12" rx="2" fill="currentColor" opacity="0.35"/>
                        <circle cx="48" cy="22" r="4" fill="currentColor" opacity="0.5"/>
                    </svg>
                </div>
                <p class="text-slate-700 font-medium">Welcome to DillDrill</p>
                <p class="text-slate-500 text-sm">Results will be displayed here.</p>
            </div>
            <div id="results-list" class="space-y-4"></div>

            <div class="mt-6 pt-4 border-t border-slate-100 text-center">
                <a href="/download-kmz" target="_blank"
                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">Download KMZ result</a>
            </div>

            <!-- Quota & Share Info -->
            <div id="meta-info" class="mt-4 text-xs text-slate-400 text-center"></div>
        </div>
        <div id="message-board" class="mt-4 p-3 text-sm rounded-lg hidden" role="status"></div>

        <footer class="mt-8 text-center text-xs text-slate-400 space-y-2">
            <div>v{{ settings.VERSION }}</div>
            <!-- Item 5: Legal & Copyright -->
            <div class="flex justify-center space-x-2">
                <a href="#" onclick="toggleAboutModal()" class="hover:text-slate-600 hover:underline">{{ t.about }}</a>
                <span>&bull;</span>
                <span id="copyright">{{ t.rights }}
                    <script>document.write(new Date().getFullYear())</script>
                </span>
            </div>
        </footer>
    </div>

    <!-- Support DillDrill Modal -->
    <div id="payment-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center transform transition-all scale-100">
            <h3 class="text-2xl font-bold text-slate-900 mb-4">{{ t.support_title }}</h3>
            <p class="text-slate-600 mb-6 leading-relaxed">
                {{ t.support_body }}
            </p>
            <button class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                onclick="togglePaymentModal()">
                {{ t.support_button }}
            </button>
            <button onclick="togglePaymentModal()" class="mt-4 text-sm text-slate-400 hover:text-slate-600">
                {{ t.close }}
            </button>
        </div>
    </div>

    <!-- About DillDrill Modal -->
    <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8 text-left transform transition-all scale-100">
            <h3 class="text-2xl font-bold text-slate-900 mb-4 text-center">{{ t.about }}</h3>
            <div class="text-slate-600 space-y-3 text-sm leading-relaxed">
                <p>
                    DillDrill is an independent international research tool that helps identify areas that may be
                    affected by construction activity before visiting or renting.
                </p>
                <p>
                    Enter latitude and longitude coordinates in decimal degrees format to explore nearby construction
                    related signals.
                </p>
                <p class="text-xs text-slate-500 italic">
                    Results are informational only and may be incomplete, outdated, or inaccurate. Always verify
                    independently.
                </p>
                <p>
                    Optional support helps cover infrastructure costs and may unlock additional daily usage capacity.
                </p>
                <div class="text-center pt-4 border-t border-slate-200 mt-4">
                    <p class="font-semibold text-slate-800">DillDrill&trade;</p>
                    <p class="text-xs text-slate-400 mt-1">2026 All rights reserved.</p>
                </div>
            </div>
            <button onclick="toggleAboutModal()"
                class="mt-6 w-full bg-slate-100 text-slate-700 py-2 rounded-lg font-medium hover:bg-slate-200 transition">
                Close
            </button>
        </div>
    </div>

    <script>
        const form = document.getElementById('search-form');
        const coordsInput = document.getElementById('coordinates');
        const searchButton = document.getElementById('search-button');
        const tokenInput = document.getElementById('turnstile-token');
        const widgetContainer = document.getElementById('turnstile-widget');
        const messageBoard = document.getElementById('message-board');
        const resultsSection = document.getElementById('results-section');
        const resultsList = document.getElementById('results-list');
        const metaInfo = document.getElementById('meta-info');
        const debugBoard = document.getElementById('debug-board');
        const debugLogsContainer = document.getElementById('debug-logs');
        const userStatusText = document.getElementById('user-status-text');
        const paymentModal = document.getElementById('payment-modal');
        const aboutModal = document.getElementById('about-modal');

        console.log("[INIT] userStatus element:", userStatusText);

        function togglePaymentModal() {
            paymentModal.classList.toggle('hidden');
        }

        function toggleAboutModal() {
            aboutModal.classList.toggle('hidden');
        }

        // I18n strings for JS
        const STRINGS = {
            searching: "{{ t.button_searching }}",
            btn_default: "{{ t.button_search }}",
            error: "{{ t.error_prefix }}",
            success: "{{ t.success_prefix }}",
            go_there: "{{ t.go_there }}",
            dist: "{{ t.distance_unit }}",
            zero_results: "No active construction detected nearby",
            waiting: "Waiting for user input...",
            disclaimer1: "DillDrill uses public data and may not catch everything.",
            disclaimer2: "Always visit in person before deciding."
        };

        const appState = {
            can_search: {{ 'true' if initial_can_search else 'false' }},
            turnstile_required: {{ 'true' if initial_turnstile_required else 'false' }},
            checks_today: {{ initial_checks_today }},
            tier: "{{ initial_tier }}"
        };

        async function refreshStatus() {
            try {
                const resp = await fetch('/api/status', { method: 'GET' });
                if (!resp.ok) return;
                const data = await resp.json();
                appState.can_search = !!data.can_search;
                appState.turnstile_required = !!data.turnstile_required;
                appState.checks_today = data.checks_today || 0;
                if (data.user_status && data.user_status.text) {
                    userStatusText.textContent = data.user_status.text;
                }
                if (widgetContainer) widgetContainer.style.display = appState.turnstile_required ? 'block' : 'none';
            } catch (_) {}
        }
        window.addEventListener('focus', () => { refreshStatus(); });

        function turnstileCallback(token) {
            tokenInput.value = token;
            if (widgetContainer) widgetContainer.style.display = 'none';
        }
        
        function setLang(code) {
            try {
                document.cookie = `dd_lang=${code}; path=/; max-age=${60*60*24*90}; samesite=lax`;
            } catch (_) {}
        }

        function resetTurnstile() {
            if (typeof turnstile !== 'undefined') {
                turnstile.reset();
                tokenInput.value = '';
                // Show widget again for next verification
                if (widgetContainer) widgetContainer.style.display = 'block';
            }
        }

        function showMessage(primary, type = 'info', secondary = '') {
            const disclaimer = `${STRINGS.disclaimer1} ${STRINGS.disclaimer2}`;
            const icon = type === 'success' ? 'âœ“' : (type === 'warning' ? 'âš ' : (type === 'error' ? 'â—»' : 'ðŸ”µ'));
            const color = type === 'success' ? 'bg-green-100 text-green-800' : (type === 'warning' ? 'bg-amber-100 text-amber-800' : (type === 'error' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'));
            messageBoard.className = `mt-4 p-3 text-sm rounded-lg ${color}`;
            messageBoard.innerHTML = `<div class="flex items-start space-x-2"><span>${icon}</span><div><div>${primary}</div>${secondary ? `<div class="text-xs text-slate-600">${secondary}</div>` : ''}<div class="text-xs italic">${disclaimer}</div></div></div>`;
            messageBoard.classList.remove('hidden');
        }
        function hideMessage() { messageBoard.classList.add('hidden'); }

        function parseCoordinates(input) {
            // Very simple parser: "lat, lon"
            const parts = input.split(',').map(s => s.trim());
            if (parts.length !== 2) return null;
            const lat = parseFloat(parts[0]);
            const lon = parseFloat(parts[1]);
            if (isNaN(lat) || isNaN(lon)) return null;
            return { lat, lon };
        }

        function renderResults(data) {
            resultsList.innerHTML = '';
            const emptyState = document.getElementById('results-empty');
            if (emptyState) emptyState.classList.add('hidden');

            data.results.forEach(poi => {
                const meters = Math.round(poi.distance_km * 1000);
                const card = `
                    <div class="card bg-white p-4 border border-slate-200 rounded-lg shadow-sm flex items-center space-x-4 hover:border-blue-300 hover:shadow-md transition-all duration-200">
                        <img src="${poi.image_url}" alt="${poi.name}" class="w-16 h-16 object-cover rounded-md flex-shrink-0 shadow-sm">
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-slate-900">${poi.name}</h3>
                            <p class="text-sm text-slate-600">${meters} ${STRINGS.dist}</p>
                        </div>
                        <a href="${poi.google_maps_link}" target="_blank"
                           class="flex-shrink-0 inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200">
                            ${STRINGS.go_there}
                        </a>
                    </div>
                `;
                resultsList.insertAdjacentHTML('beforeend', card);
            });

            resultsSection.classList.remove('hidden');
            // Populate Debug Board (Item 4)
            if (data.debug_logs && data.debug_logs.length > 0) {
                debugBoard.classList.remove('hidden');
                debugLogsContainer.innerHTML = data.debug_logs.map(log => `<div>> ${log}</div>`).join('');
                // Auto-scroll to bottom
                debugLogsContainer.scrollTop = debugLogsContainer.scrollHeight;
            } else {
                debugBoard.classList.add('hidden');
            }
        }

        form.addEventListener('submit', async e => {
            e.preventDefault();
            hideMessage();
            resultsSection.classList.add('hidden');
            searchButton.disabled = true;
            searchButton.textContent = STRINGS.searching;

            const inputVal = coordsInput.value;
            const turnstile_token = tokenInput.value;
            if (!appState?.can_search) {
                togglePaymentModal();
                searchButton.disabled = false;
                searchButton.textContent = STRINGS.btn_default;
                return;
            }
            if (appState?.turnstile_required && !turnstile_token) {
                showMessage("Please complete the human verification.", 'error');
                searchButton.disabled = false;
                searchButton.textContent = STRINGS.btn_default;
                return;
            }

            const coords = parseCoordinates(inputVal);
            if (!coords) {
                showMessage("Use decimal degrees", 'error');
                searchButton.disabled = false;
                searchButton.textContent = STRINGS.btn_default;
                return;
            }

            let success = false;
            try {

                const response = await fetch('/api/find-nearest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lat: coords.lat,
                        lon: coords.lon,
                        turnstile_token
                    })
                });

                // Capture Request ID for debugging
                const reqId = response.headers.get('X-Request-ID');
                if (reqId) {
                    console.log("Request ID:", reqId);
                }

                const data = await response.json();
                console.log("[DEBUG] Full response data:", data);

                if (response.ok) {
                    success = true;
                    coordsInput.value = '';
                    coordsInput.blur();
                    if (data.results.length === 0) {
                        showMessage(STRINGS.zero_results, 'success');
                    } else {
                        renderResults(data);
                        showMessage(`${STRINGS.success}`, 'success', `Found ${data.results.length} projects.`);
                    }
                    userStatusText.textContent = data.user_status?.text || userStatusText.textContent;
                    appState.can_search = !!data.can_search;
                    appState.turnstile_required = !!data.turnstile_required;
                    if (widgetContainer) widgetContainer.style.display = 'none';
                } else {
                    let errMsg = 'Unknown error';
                    if (data.detail) {
                        if (data.detail.detail) {
                            errMsg = data.detail.detail;
                        } else {
                            errMsg = JSON.stringify(data.detail);
                        }
                    }

                    // Append Request ID to error message if available
                    if (reqId) {
                        errMsg += ` (Req ID: ${reqId})`;
                    }
                    if (data.detail && data.detail.error === "QUOTA_EXCEEDED") {
                        togglePaymentModal();
                        userStatusText.textContent = "{{ t.status_limit if t.status_limit else 'Daily limit reached' }}";
                    } else {
                        showMessage(`${STRINGS.error}: ${errMsg}`, 'error');
                    }

                    if (data.detail && data.detail.error === "CHALLENGE_REQUIRED") {
                        resetTurnstile();
                    }
                }
            } catch (err) {
                console.error('Fetch error:', err);
                if (!success) {
                    showMessage(`${STRINGS.error}: Network error.`, 'error');
                }
            } finally {
                searchButton.disabled = false;
                searchButton.textContent = STRINGS.btn_default;

                if (!success && resultsList.childElementCount === 0) {
                    setTimeout(() => {
                        showMessage(STRINGS.waiting, 'info');
                    }, 10000);
                }
            }
        });
        refreshStatus();
    </script>

</body>

</html>
