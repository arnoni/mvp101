<!DOCTYPE html>
<html lang="{{ current_lang }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t.title }}</title>
    <!-- Tailwind CSS (mock) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Drilling/Rumble Animation for Item 3 */
        @keyframes drill-rumble {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }

            2% {
                transform: translate(-1px, 1px) rotate(-1deg);
            }

            4% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            6% {
                transform: translate(-1px, -1px) rotate(-1deg);
            }

            8% {
                transform: translate(1px, 1px) rotate(1deg);
            }

            10% {
                transform: translate(0, 0) rotate(0deg);
            }

            /* Pause */
            100% {
                transform: translate(0, 0) rotate(0deg);
            }
        }

        .drill-text {
            /* Drill sound visual: bursts of vibration */
            animation: drill-rumble 2s infinite linear;
            display: inline-block;
        }

        .drill-text:hover {
            /* Continuous drilling on hover */
            animation: drill-rumble 0.2s infinite linear;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8 font-sans text-slate-900">
    <div class="max-w-md w-full space-y-6 bg-white p-8 rounded-2xl shadow-xl border border-slate-100 relative">
        <!-- Item 1: User Plan & Quota (Top-Left) -->
        <div class="absolute top-4 left-4 flex flex-col items-start text-xs space-y-1">
            <button onclick="togglePaymentModal()"
                class="font-bold text-blue-600 hover:text-blue-800 hover:underline focus:outline-none">
                PLAN: <span id="user-plan">{{ user_plan }}</span>
            </button>
            <div class="text-slate-500">
                Quota: <span id="quota-display" class="font-mono font-medium text-slate-700">{{ quota_remaining
                    }}</span>
            </div>
        </div>

        <!-- Language Selector -->
        <div class="absolute top-4 right-4 flex space-x-2 text-xs">
            <a href="?lang=en" class="hover:underline {% if current_lang == 'en' %}font-bold{% endif %}">EN</a>
            <span class="text-slate-300">|</span>
            <a href="?lang=es" class="hover:underline {% if current_lang == 'es' %}font-bold{% endif %}">ES</a>
            <span class="text-slate-300">|</span>
            <a href="?lang=ru" class="hover:underline {% if current_lang == 'ru' %}font-bold{% endif %}">RU</a>
            <span class="text-slate-300">|</span>
            <a href="?lang=ko" class="hover:underline {% if current_lang == 'ko' %}font-bold{% endif %}">KO</a>
        </div>

        <header class="text-center mb-6 mt-6">
            <!-- Item 2 & 3: Animated Branding with Drilling Effect -->
            <div class="mb-4 flex flex-col items-center justify-center">
                <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight drill-text relative">
                    DillDrill
                    <!-- Item 2: TM Mark (Explicitly positioned and styled) -->
                    <span class="absolute -top-2 -right-6 text-sm font-bold text-slate-400 select-none">&trade;</span>
                </h1>
            </div>
            <p class="text-slate-500 mt-1">{{ t.subtitle }}</p>
        </header>

        <form id="search-form" class="space-y-4">
            <div class="flex justify-between items-center">
                <label for="coordinates" class="block text-sm font-medium text-slate-700">{{ t.input_label }}</label>
                <!-- Item 3: Tutorial Link -->
                <a href="#" class="text-xs text-blue-500 hover:text-blue-700 hover:underline">How to use the app</a>
            </div>
            <input type="text" id="coordinates" name="coordinates" required placeholder="{{ t.placeholder }}"
                class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg shadow-sm transition-all duration-200">

            {% if settings.ENV == 'development' %}
            <div
                class="p-3 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg mb-4 text-sm flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Dev Mode: Extended error info enabled. Turnstile Verification Required.
            </div>
            {% endif %}

            <!-- Turnstile Widget (Always Visible) -->
            <div id="turnstile-widget" class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}"
                data-callback="turnstileCallback"></div>
            <input type="hidden" id="turnstile-token" name="turnstile_token">

            <button type="submit" id="search-button"
                class="w-full bg-blue-600 text-white py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 shadow-md transition-all duration-200">
                {{ t.button_search }}
            </button>
        </form>

        <div id="status-message" class="mt-4 p-3 text-sm rounded-lg hidden" role="alert"></div>

        <div id="results-section" class="mt-8 space-y-4 hidden">
            <h2 class="text-xl font-semibold text-slate-800">{{ t.results_header }}</h2>
            <div id="results-list" class="space-y-4"></div>

            <div class="mt-6 pt-4 border-t border-slate-100 text-center">
                <a href="/download-kmz" target="_blank"
                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">Download KMZ result</a>
            </div>

            <!-- Quota & Share Info -->
            <div id="meta-info" class="mt-4 text-xs text-slate-400 text-center"></div>
        </div>

        <footer class="mt-8 text-center text-xs text-slate-400 space-y-2">
            <div>v{{ settings.VERSION }}</div>
            <!-- Item 5: Legal & Copyright -->
            <div class="flex justify-center space-x-2">
                <a href="#" class="hover:text-slate-600 hover:underline">About DillDrill</a>
                <span>&bull;</span>
                <span id="copyright">All rights reserved
                    <script>document.write(new Date().getFullYear())</script>
                </span>
            </div>
        </footer>
    </div>

    <!-- Item 1: Payment Funnel Modal -->
    <div id="payment-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center transform transition-all scale-100">
            <h3 class="text-2xl font-bold text-slate-900 mb-2">Upgrade to Pro</h3>
            <p class="text-slate-600 mb-6">Get unlimited searches and premium features.</p>
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                <span class="text-3xl font-bold text-blue-600">$3.99</span>
                <span class="text-blue-400">/ month</span>
            </div>
            <button class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition"
                onclick="togglePaymentModal()">
                Processing... (Mock)
            </button>
            <button onclick="togglePaymentModal()" class="mt-4 text-sm text-slate-400 hover:text-slate-600">
                Close
            </button>
        </div>
    </div>

    <script>
        const form = document.getElementById('search-form');
        const coordsInput = document.getElementById('coordinates');
        const searchButton = document.getElementById('search-button');
        const tokenInput = document.getElementById('turnstile-token');
        const widgetContainer = document.getElementById('turnstile-widget');
        const statusMessage = document.getElementById('status-message');
        const resultsSection = document.getElementById('results-section');
        const resultsList = document.getElementById('results-list');
        const metaInfo = document.getElementById('meta-info');
        const debugBoard = document.getElementById('debug-board');
        const debugLogsContainer = document.getElementById('debug-logs');
        const quotaDisplay = document.getElementById('quota-display');
        const userPlanDisplay = document.getElementById('user-plan');
        const paymentModal = document.getElementById('payment-modal');

        function togglePaymentModal() {
            paymentModal.classList.toggle('hidden');
        }

        // I18n strings for JS
        const STRINGS = {
            searching: "{{ t.button_searching }}",
            btn_default: "{{ t.button_search }}",
            error: "{{ t.error_prefix }}",
            success: "{{ t.success_prefix }}",
            go_there: "{{ t.go_there }}",
            dist: "{{ t.distance_unit }}",
            zero_results: "You have a green light! No construction nearby found.",
            waiting: "Waiting for user input..."
        };

        function turnstileCallback(token) {
            tokenInput.value = token;
            // Hide widget to reduce visual clutter after verification
            if (widgetContainer) widgetContainer.style.display = 'none';
        }

        function resetTurnstile() {
            if (typeof turnstile !== 'undefined') {
                turnstile.reset();
                tokenInput.value = '';
                // Show widget again for next verification
                if (widgetContainer) widgetContainer.style.display = 'block';
            }
        }

        function showStatus(msg, type = 'info') {
            statusMessage.textContent = msg;
            statusMessage.className = 'mt-4 p-3 text-sm rounded-lg';
            statusMessage.classList.remove('hidden');

            // Remove all specific color classes first
            statusMessage.classList.remove('bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800', 'bg-slate-100', 'text-slate-600');

            if (type === 'error') statusMessage.classList.add('bg-red-100', 'text-red-800');
            else if (type === 'success') statusMessage.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'waiting') statusMessage.classList.add('bg-slate-100', 'text-slate-600');
            else statusMessage.classList.add('bg-blue-100', 'text-blue-800');
        }

        function hideStatus() { statusMessage.classList.add('hidden'); }

        function parseCoordinates(input) {
            // Very simple parser: "lat, lon"
            const parts = input.split(',').map(s => s.trim());
            if (parts.length !== 2) return null;
            const lat = parseFloat(parts[0]);
            const lon = parseFloat(parts[1]);
            if (isNaN(lat) || isNaN(lon)) return null;
            return { lat, lon };
        }

        function renderResults(data) {
            resultsList.innerHTML = '';

            data.results.forEach(poi => {
                const meters = Math.round(poi.distance_km * 1000);
                const card = `
                    <div class="card bg-white p-4 border border-slate-200 rounded-lg shadow-sm flex items-center space-x-4 hover:border-blue-300 hover:shadow-md transition-all duration-200">
                        <img src="${poi.image_url}" alt="${poi.name}" class="w-16 h-16 object-cover rounded-md flex-shrink-0 shadow-sm">
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-slate-900">${poi.name}</h3>
                            <p class="text-sm text-slate-600">${meters} ${STRINGS.dist}</p>
                        </div>
                        <a href="${poi.google_maps_link}" target="_blank"
                           class="flex-shrink-0 inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200">
                            ${STRINGS.go_there}
                        </a>
                    </div>
                `;
                resultsList.insertAdjacentHTML('beforeend', card);
            });

            // Meta Info
            metaInfo.innerHTML = `Quota Remaining: ${data.quota_remaining}`;

            resultsSection.classList.remove('hidden');

            // Update Header Quota
            if (data.quota_remaining !== undefined) {
                quotaDisplay.textContent = Math.max(0, data.quota_remaining);
            }

            // Populate Debug Board (Item 4)
            if (data.debug_logs && data.debug_logs.length > 0) {
                debugBoard.classList.remove('hidden');
                debugLogsContainer.innerHTML = data.debug_logs.map(log => `<div>> ${log}</div>`).join('');
                // Auto-scroll to bottom
                debugLogsContainer.scrollTop = debugLogsContainer.scrollHeight;
            } else {
                debugBoard.classList.add('hidden');
            }
        }

        form.addEventListener('submit', async e => {
            e.preventDefault();
            hideStatus();
            resultsSection.classList.add('hidden');
            searchButton.disabled = true;
            searchButton.textContent = STRINGS.searching;

            const inputVal = coordsInput.value;
            const turnstile_token = tokenInput.value;

            const coords = parseCoordinates(inputVal);
            if (!coords) {
                showStatus(STRINGS.error + ": Invalid coordinates format. Use 'lat, lon'", 'error');
                searchButton.disabled = false;
                searchButton.textContent = STRINGS.btn_default;
                return;
            }

            try {

                const response = await fetch('/api/find-nearest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lat: coords.lat,
                        lon: coords.lon,
                        turnstile_token
                    })
                });

                // Capture Request ID for debugging
                const reqId = response.headers.get('X-Request-ID');
                if (reqId) {
                    console.log("Request ID:", reqId);
                }

                const data = await response.json();

                if (response.ok) {
                    if (data.results.length === 0) {
                        showStatus(STRINGS.zero_results, 'success');
                    } else {
                        renderResults(data);
                        showStatus(`${STRINGS.success}! Found ${data.results.length} projects.`, 'success');
                    }
                } else {
                    let errMsg = 'Unknown error';
                    if (data.detail && data.detail.detail) {
                        errMsg = data.detail.detail;
                    } else if (data.detail) {
                        errMsg = JSON.stringify(data.detail);
                    }
                    // Append Request ID to error message if available
                    if (reqId) {
                        errMsg += ` (Req ID: ${reqId})`;
                    }
                    showStatus(`${STRINGS.error}: ${errMsg}`, 'error');

                    if (data.detail && data.detail.error === "CHALLENGE_REQUIRED") {
                        resetTurnstile();
                    }
                }
            } catch (err) {
                console.error('Fetch error:', err);
                showStatus(`${STRINGS.error}: Network error.`, 'error');
            } finally {
                // Determine if we should reset turnstile right away
                // TDD implies Friction. Strict security resets every time.
                // User wants "reappear when need another one".
                resetTurnstile();
                searchButton.disabled = false;
                searchButton.textContent = STRINGS.btn_default;

                // Status update timeout
                setTimeout(() => {
                    showStatus(STRINGS.waiting, 'waiting');
                }, 10000);
            }
        });
    </script>

</body>

</html>